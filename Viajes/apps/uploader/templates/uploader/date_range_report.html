{% extends 'uploader/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/date_range_report.css' %}">
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    // Variable global para el prefijo de URL (funciona en desarrollo y producción)
    window.URL_PREFIX = '{{ request.META.SCRIPT_NAME|default:"" }}';
</script>
<script src="{% static 'js/date_range_report.js' %}?v=8"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold mb-2">
            <i class="fas fa-calendar-alt mr-2 text-green-600"></i>
            Reporte por Fecha
        </h1>
        <p class="text-base-content/70">
            <i class="fas fa-info-circle text-green-600 mr-1"></i>
            Este reporte muestra únicamente los registros marcados con <strong>SR (Segunda Revisión)</strong>, <strong>R (Rechazado)</strong> o <strong>I (Internación)</strong>.
            Los pasajeros sin marcas cruzaron correctamente y no aparecen aquí.
        </p>
    </div>

    <!-- Formulario de búsqueda -->
    <div class="card bg-white shadow-xl border border-green-200 mb-6">
        <div class="card-body">
            <div class="flex justify-between items-center cursor-pointer" onclick="toggleFiltros()">
                <h2 class="card-title">
                    <i class="fas fa-search mr-2 text-green-600"></i>
                    Rango de fechas para filtrar
                </h2>
                <i class="fas fa-chevron-down text-green-600 transition-transform" id="filtros-toggle"></i>
            </div>
            
            <form method="GET" id="filtros-content" class="mt-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-calendar-day mr-1"></i>
                            Fecha Inicio
                        </span>
                    </label>
                    <input 
                        type="date" 
                        name="fecha_inicio" 
                        id="fecha_inicio"
                        class="input input-bordered" 
                        value="{{ fecha_inicio }}"
                        min="2025-11-10"
                        required
                    >
                    <label class="label">
                        <span class="label-text-alt">Mínimo: 10/11/2025</span>
                    </label>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-calendar-day mr-1"></i>
                            Fecha Fin
                        </span>
                    </label>
                    <input 
                        type="date" 
                        name="fecha_fin" 
                        id="fecha_fin"
                        class="input input-bordered" 
                        value="{{ fecha_fin }}"
                        min="2025-11-10"
                        required
                    >
                    <label class="label">
                        <span class="label-text-alt">Mínimo: 10/11/2025</span>
                    </label>
                </div>
            </div>

            <div class="card-actions justify-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search mr-1"></i>
                    Buscar Registros
                </button>
                {% if fecha_inicio or fecha_fin %}
                <a href="{% url 'date_range_report' %}" class="btn btn-ghost">
                    <i class="fas fa-rotate-right mr-1"></i>
                    Limpiar Filtros
                </a>
                {% endif %}
            </div>
            </form>
        </div>
    </div>
    
    {% if estadisticas_por_fecha %}
    <!-- Agrupación por fecha -->
    {% for stat in estadisticas_por_fecha %}
    <div class="fecha-grupo mb-6">
        <!-- Encabezado de fecha -->
        <div class="fecha-header cursor-pointer hover:bg-base-300 transition-colors" onclick="toggleFecha(this)">
            <div class="flex items-center gap-3">
                <i class="fas fa-chevron-down fecha-toggle transition-transform"></i>
                <i class="fas fa-calendar-day text-primary"></i>
                <h3 class="fecha-titulo">{{ stat.fecha|date:"l, d \d\e F \d\e Y"|title }}</h3>
            </div>
            <div class="flex gap-2 items-center">
                <!-- Botón Generar PIN -->
                <button 
                   class="btn btn-sm btn-accent gap-1" 
                   onclick="event.stopPropagation(); abrirModalPin('{{ stat.fecha|date:'Y-m-d' }}', '{{ stat.fecha|date:'l, d \d\e F \d\e Y'|title }}', {{ stat.total }}, {{ stat.segunda_revisions }}, {{ stat.internaciones }}, {{ stat.rechazados }})"
                   title="Generar PIN Oficial">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 384 512">
                        <path d="M32 32C32 14.3 46.3 0 64 0H320c17.7 0 32 14.3 32 32s-14.3 32-32 32H290.5l11.4 148.2c36.7 19.9 65.7 53.2 79.5 94.7l1 3c3.3 9.8 1.6 20.5-4.4 28.8s-15.7 13.3-26 13.3H32c-10.3 0-19.9-5-26-13.3s-7.7-19.1-4.4-28.8l1-3c13.8-41.5 42.8-74.8 79.5-94.7L93.5 64H64C46.3 64 32 49.7 32 32zM160 384h64v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384z"/>
                    </svg>
                    PIN
                </button>
                
                <span class="badge badge-primary badge-lg">Total: {{ stat.total }}</span>
                {% if stat.segunda_revisions > 0 %}
                <span class="badge badge-warning badge-lg">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    SR: {{ stat.segunda_revisions }}
                </span>
                {% endif %}
                {% if stat.rechazados > 0 %}
                <span class="badge badge-error badge-lg">
                    <i class="fas fa-times-circle mr-1"></i>
                    R: {{ stat.rechazados }}
                </span>
                {% endif %}
                {% if stat.internaciones > 0 %}
                <span class="badge badge-info badge-lg">
                    <i class="fas fa-plane-arrival mr-1"></i>
                    I: {{ stat.internaciones }}
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Tabla de registros -->
        <div class="overflow-x-auto fecha-content">
            <table class="table table-sm table-zebra">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Vuelo</th>
                        <th>Pasajero</th>
                        <th>Documento</th>
                        <th>Asiento</th>
                        <th>Salida → Llegada</th>
                        <th>Estado</th>
                        <th>Archivo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registro in stat.registros %}
                    <tr>
                        <td>{{ registro.id }}</td>
                        <td class="font-bold">{{ registro.vuelo_numero }}</td>
                        <td>{{ registro.nombre_pasajero }}</td>
                        <td>{{ registro.numero_documento }}</td>
                        <td>{{ registro.numero_asiento }}</td>
                        <td>
                            <span class="text-xs">
                                {{ registro.aeropuerto_salida }} → {{ registro.aeropuerto_llegada }}
                            </span>
                        </td>
                        <td>
                            {% if registro.segunda_revision %}
                                <span class="badge badge-warning badge-sm">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    SR
                                </span>
                            {% endif %}
                            {% if registro.rechazado %}
                                <span class="badge badge-error badge-sm">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    R
                                </span>
                            {% endif %}
                            {% if registro.internacion %}
                                <span class="badge badge-info badge-sm">
                                    <i class="fas fa-plane-arrival mr-1"></i>
                                    I
                                </span>
                            {% endif %}
                            {% if not registro.segunda_revision and not registro.rechazado and not registro.internacion %}
                                <span class="badge badge-ghost badge-sm">
                                    <i class="fas fa-clock mr-1"></i>
                                    Pendiente
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-xs">
                            {{ registro.batch.archivo.name|slice:"8:" }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}

    {% elif fecha_inicio or fecha_fin %}
    <div class="alert alert-success">
        <i class="fas fa-check-circle text-2xl"></i>
        <div>
            <p class="font-bold">No se encontraron casos especiales en este rango de fechas</p>
            <p class="text-sm">Todos los pasajeros cruzaron correctamente (sin marcas de SR, R o I)</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal PIN -->
<dialog id="modalPin" class="modal">
    <div class="modal-box max-w-3xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-success" fill="currentColor" viewBox="0 0 384 512">
                    <path d="M32 32C32 14.3 46.3 0 64 0H320c17.7 0 32 14.3 32 32s-14.3 32-32 32H290.5l11.4 148.2c36.7 19.9 65.7 53.2 79.5 94.7l1 3c3.3 9.8 1.6 20.5-4.4 28.8s-15.7 13.3-26 13.3H32c-10.3 0-19.9-5-26-13.3s-7.7-19.1-4.4-28.8l1-3c13.8-41.5 42.8-74.8 79.5-94.7L93.5 64H64C46.3 64 32 49.7 32 32zM160 384h64v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384z"/>
                </svg>
                PIN Oficial del INM
            </h3>
            
            <div class="flex gap-2">
                <button onclick="copiarPin(event)" class="btn btn-primary btn-sm gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Copiar PIN
                </button>
                <button onclick="generarPDF()" class="btn btn-error btn-sm gap-2 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    PIN PDF
                </button>
                <button onclick="location.reload()" class="btn btn-secondary btn-sm gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Volver
                </button>
                <button onclick="cerrarModalPin()" class="btn btn-ghost btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Contenido del PIN -->
        <div class="bg-base-200 p-6 rounded-lg max-h-96 overflow-y-auto" id="contenidoPin">
            <div class="space-y-4 text-base leading-relaxed">
                <!-- El contenido se cargará dinámicamente -->
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button onclick="cerrarModalPin()">close</button>
    </form>
</dialog>

{% endblock %}

